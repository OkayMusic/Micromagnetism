gap = 0.5; from = -10; to = 10;
% BEGIN DEFINING PHYSICAL PARAMETERS
STIFF_CONST = 1;
DM_CONST = 0.25;
B_FIELD = [0,0,0.1];
PARAMS = [STIFF_CONST, DM_CONST, B_FIELD];

[X, Y, Z] = meshgrid(from:gap:to, from:gap:to,1);
vol = size(X);

close all

DELTA = pi;
theta = pi*rand(vol(1), vol(2));
phi = 2*pi*rand(vol(1), vol(2));

disp(calculate_total_energy(theta, phi, PARAMS))



for k=1:400
for i=1:vol(1)
    for j=1:vol(2)
        a = randi(vol(1)); b = randi(vol(2));
        [theta(a, b), phi(a, b)] =...
            wiggle(theta, phi, a, b,DELTA, PARAMS);
    end
end

% pause(0.000000001)

if DELTA >  pi * 0.001
    DELTA = DELTA/1.01;
end
end
disp(calculate_total_energy(theta, phi, PARAMS))

figure
Mx = sin(theta).*cos(phi);
My = sin(theta).*sin(phi);
Mz = cos(theta);
surf(X, Y, Mz,'EdgeColor','none','LineStyle','none','FaceColor','interp')
alpha(0.5)


hold on

qui = quiver3(X, Y,Z, Mx, My, Mz);

qui.Color = 'black';
qui.LineStyle = '-';
qui.LineWidth = 1.5;
qui.ShowArrowHead = 'on';
qui.MaxHeadSize = 100;
qui.AutoScale = 'on';
qui.AutoScaleFactor = 1.2;
qui.AlignVertexCenters = 'on';

daspect([1,1,1])
set(gcf, 'Position', get(0, 'Screensize'));
view(0, 90)
caxis([-1,1])

hold off
view(0, 90)



dM_dx(:,:,1) = diff(Mx')'./gap; 
dM_dx(:,:,2) = diff(My')'./gap; 
dM_dx(:,:,3) = diff(Mz')'./gap;
dM_dy(:,:,1) = diff(Mx)./gap;   
dM_dy(:,:,2) = diff(My)./gap;   
dM_dy(:,:,3) = diff(Mz)./gap;

crossed_field = cross(dM_dy(:,1:vol(2)-1,:), dM_dx(1:vol(1)-1,:,:), 3);
integrand = dot(M(1:vol(1)-1,1:vol(2)-1, :), crossed_field, 3);
N_skyrme = gap^2*sum(sum(integrand))/(4*pi);

disp(N_skyrme)
